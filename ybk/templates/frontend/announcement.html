{% extends "layout.html" %}

{% block css %}
    <link href="{{ url_for('static', filename='css/selectize.bootstrap3.css') }}" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="邮币卡公告聚合 {% if exchange %}- {{exchange }} {% endif %}{% if type_ %}- {{typecn}} {% endif %}- RSS订阅" href="{{ url_for('frontend.announcement_feed', exchange=exchange, type=type_) }}" />
{% endblock %}

{% block main %}
    <div class="row">
      <div class="col-md-12">
        <h2>
            公告信息聚合 
            <a href="{{ url_for('frontend.announcement_feed', exchange=exchange, type=type_) }}">
                <img src="{{ url_for('static', filename='img/feed-icon-28x28.png') + '?offer='}}">
            </a>
        </h2> 
        <p>*每逢整点更新, 上次更新时间 {{ updated_at | bjtime }}</p>
        <div class="filters">
          <div class="header">
            <span class="title">公告筛选</span> 
            <span class="total">(共{{ total }}个公告)</span>
          </div>

          <!-- 已选中 -->
          {% if type_ or exchange %}
          <div class="filter row">
            <span class="name col-md-1">已选条件:</span>
            <ul class="values col-md-11">
              {% if type_ %}
                <li class="selected">
                  <a href="#">
                  公告类型: 
                  <strong>{{ typecn }} &times;</strong>&nbsp;
                  </a>
                </li>
              {% endif %}
              {% if exchange %}
                <li class="selected">
                  <a href="#">
                  交易所: 
                  <strong>{{ exchange }} &times;</strong>&nbsp;
                  </a>
                </li>
              {% endif %}
              <a class="pull-right" href="{{ url_for('frontend.announcement') }}">全部撤销</a>
            </ul>
          </div>
          {% endif %}

          <!-- 筛选条件 -->
          {% for fname, ftype, fvalue, fchoices in 
                  [['公告类型', 'type', type_, typecns],
                   ['交易所', 'exchange', exchange, exchanges],] %}
          {% if not fvalue %}
          <div class="filter row">
            <span class="name col-md-1">{{ fname }}:</span>
            <ul class="values col-md-11">
            {% for choice in fchoices %}
              <li><a href="#" data-type="{{ ftype }}">{{ choice }}</a></li>
            {% endfor %}
            </ul>
          </div>
          {% endif %}
          {% endfor %}

        </div>
        <table class="table table-striped">
          <thead>
            <th class="col-md-2">交易所</th>
            <th class="col-md-1">类别</th>
            <th class="col-md-7">标题</th>
            <th class="col-md-2">时间</th>
          </thead>
          <tbody>
          {% for a in announcements %}
            <tr>
              <td><a href="{{ url_for('frontend.announcement', exchange=a.exchange) }}">{{ a.exchange }}</a></td>
              <td><a href="{{ url_for('frontend.announcement', type=a.type_) }}">{{ a.typecn }}</a></td>
              <td>
                <a href="{{ a.url }}" target="_blank">
                  {{ a.title }}
                </a>
              </td>
              <td>{{ a.published_at | bjdate }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <nav style="margin-top:-30px;">
          <ul class="pagination">
            {% if pagination.has_prev %}
            <li>
              <a href="#" aria-label="上一页" data-page="{{pagination.page-1}}">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
            {% endif %}
            {%- for page in pagination.iter_pages() %}
                {% if page %}
                  {% if page != pagination.page %}
                    <li><a href="#" data-page="{{page}}">{{ page }}</a></li>
                  {% else %}
                    <li class="active"><a>{{ page }}</a></li>
                  {% endif %}
                {% else %}
                    <li><span class=ellipsis>…</span></li>
                {% endif %}
            {%- endfor %}
            {% if pagination.has_next %}
            <li>
              <a href="#" aria-label="下一页" data-page="{{pagination.page+1}}">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>
{% endblock %}

{% block js %}
    <script src="{{ url_for('static', filename='js/selectize.min.js') }}"></script>
    <script>
        function reselect(page){
            if (isNaN(page)){
                page = 1;
            }
            var params = {
                exchange: $('#select-exchange').val(),
                type: $('#select-type').val(),
                page: page,
            }
            location.href = "{{ url_for('frontend.announcement') }}"+ '?' + $.param(params);
        }
        $('#select-exchange').selectize({
            onChange: reselect,
        })
        $('#select-type').selectize({
            onChange: reselect,
        });
        $('.pagination').on('click', 'a', function(){
            reselect($(this).data('page'));
        });
    </script>
{% endblock %}