# 通讯协议(winner)

本文档记录邮币卡交易所客户端的协议(非官方)

本通讯协议适用交易所如下:

'湖南文交所', '海西文交所', '上海邮币卡', '上海文交所'


0. [通用](#common)
0. [网络层](#network)
0. [业务层](#business)

## <a id="common">通用</a>

与sysframe系统不同, winner系统为纯TCP协议, 需要用androguard解包阅读并与wiredshark监听比较着阅读

```py
import socket
s = socket.socket()
s.connect(('101.226.171.220', 7002))
s.send(req)
s.recv(...)
```


## <a id="network">网络层</a>

- 总体结构

发送和接受包的结构都是一样的

```bash
95 00 00 95 # 长度
# 第一位是校验位, 为后三位的xor
# \x00+后三位 -> '>i', 表示接下来的包长度

   KEY 3d VALUE 00 # 字典
   # 接下来为一堆key, value对, key一般为一个数字字字符串
   # 例如"33 3d 31 00", "3" -> "1"
   # 不同的数字的意义见之后的网络层代码表
   ...
```

- 网络层代码表

```bash
"11": 代表包的序号, 数字字符串, "500"起
"13": "8" 00
"5": functionId, 取k线时为"36862"
"4": subSystemId, 取k线时为"109"
"2": 打包的StringArray
	3d LENGTH 00 KEY 3d 
		VALUE 00
		...
	# LENGTH为字符串的个数, 
"1": 打包的ByteArray(封装了BizMsgPack)
	3d LENGTH 00 KEY 3d VALUE 00
	# LENGTH为VALUE的长度, 数字字符串
	# "8"为BizMsgPack
	# "69"为mobileMap, 有一个markid的东东
	# "70"为jrNvMap, 不明物体
```

- 接收
	- 与发送不一样的是，接收发现是"8", 需要解压缩(zlib)

	
## <a id="business">业务层</a>

- 业务头

```bash
fe 8f 00 00 00 00 00 00
00 00 00 00 00 00 00 00

# 前16位为头部
# 前两位为'<H'
# 36862 -> 行情
```

- K线

>b'\x95\x00\x00\x9511=524\x0013=8\x005=36862\x004=109\x001=66\x008=\xfe\x8f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00,\x00\x02\x04\x00\x00\x00\x00\x00\x00\x013614016\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00Z\x000\x00\x013614016\x00\x00\x00\x00\x00\x00\x001=40\x0069=markid=60ba7308cab942ee961536a74ec7c5f9\x00\x00'

```bash
01 00 个数
# 长度们
	2c 00 包的长度
	..
# 内容们
	# DataHead
	02 04 '<H' 格式的类型, 1006 -> K线
	00 index?
	00 operator?
	00 00 00 00 '<I' key? 
	01 33 symbol type
	6  0  0  0  0  1  symbol
	# DataContent
	# 请求:
		03 00 # 个数
		00 00 # 保留
			# 第一个, 10代表日线, 30代表分钟线
			00 00 00 00 00 00 00 00
			5a 00 10 00 01 33 6  0 
			0  0  0  1  00 00 00 00
			
			# 第2个, 空
			00 
			
			# 第3个, 空
			00
	# 应答:
		5a 00 00 00 # 个数
			
			4d 79 33 01 # 日期 20150605 '<I'
			2  cb 00 00 # 开盘价格 3250 '<i'
			2  cb 00 00 # 最高价格 3250 '<i'
			2  cb 00 00 # 最低价格 3250 '<i'
			2  cb 00 00 # 收盘价格 3250 '<i'
			20 00 00 00 # 成交金额(元) 32 '<i'
			01 00 00 00 # 成交笔数 1 '<i'
			00 00 00 00 # nationalDebtRatio?
			
```